<?php/***	用户登录页面**/class LoginController  extends Yaf_Controller_Abstract {	protected $session ;	public function indexAction() {		$this->session = Yaf_Session::getInstance();		if ($this->session->get('login') == 1) {			echo "<script>alert('Already login.')</script>";			//sleep(3);			$this->redirect(Yaf_Application::app()->getConfig()->domain->name."/");		} 				if (Yaf_Registry::get("register")) {			$this->getView()->assign("activekey",Yaf_Registry::get("register"));		}				$navbars = $this->getnavbar("login");		$rightbars = $this->getrightbar("register");						$this->getView()->assign("title"," 登录 - i比熊 ");		$this->getView()->assign("navbar",$navbars);		$this->getView()->assign("rightbar",$rightbars);		$this->getView()->display(Yaf_Application::app()->getConfig()->smarty->template_dir . "index/login.tpl");	}		public function loginAction() {		$this->session = Yaf_Session::getInstance();		if ($this->getRequest()->isPost()) {					if ($this->session->get('login') == 1) {				echo "<script>alert('您已经登录了')</script>";				//sleep(3);				$this->redirect(Yaf_Application::app()->getConfig()->domain->name."/");			} 									$this->session->start();			$loginmodel = new LoginModel();			//echo __METHOD__ ."has been called";			$userlogin = $this->getRequest()->getPost("username");			$logintype = '';			//echo "<pre>";			if (empty($userlogin)) {				echo "用户名为空";				exit();			} else if (preg_match_all("/^[a-zA-Z0-9_]{3,16}$/i", $userlogin, $matches)) {				$logintype = 'user_login';			} else if (preg_match_all("/^[\w\d]+[\w\d-.]*@[\w\d-.]+\.[\w\d]{2,10}$/i", $userlogin, $matches)) {				$logintype = 'user_email';			} else {				echo "用户名不合法";				exit();			}			$data['user_login'] = $userlogin;			$data['user_password'] = $this->getRequest()->getPost("password");									$data['user_lastlogintime'] = date("Y-m-d H:i:s");			$data['user_lastlogintime_gmt'] = date("e");			$data['user_lastlogin_ip'] = $_SERVER['REMOTE_ADDR'];			//print_r($data);			//print_r($logintype);			$user_info = $loginmodel->get_user($logintype,$data['user_login']);			//print_r($user_info);			if ($user_info['user_id']) {				//echo "user_login is find";				$salt = $user_info['user_salt'];				$password = md5($data['user_password'].$salt);				//print_r($password);				if ($password == $user_info['user_password']) {					$this->session->set('login',1);					$this->session->set('userid',$user_info['user_id']);					//$this->session->set('username',$user_info['user_login']);					$this->session->set('username',$user_info['user_nickname']);					echo "1:登陆成功";				}								if ($this->getRequest()->getPost("rememberme")) {					$domain = "www.ibixiong.com";					setcookie("userid", $user_info['user_id'], time()+3600*24*365,"/",$domain,0,true);  					setcookie("username", $user_info['user_login'], time()+3600*24*365,"/",$domain,0,true);  					setcookie("password", $user_info['user_password'], time()+3600*24*365,"/",$domain,0,true); 									}			}			//登录后跳转			if ($this->session->get('login') == 1) {				/*echo $this->getRequest()->getCookie('username');				echo "<br />";				echo $this->getRequest()->getCookie('password');*/				if (!empty($_SERVER['HTTP_REFERER'])) {					$url = $_SERVER['HTTP_REFERER'];					$url_parts = explode('/', $url, 3);					$host = $url_parts[2];					if (preg_match('/.*\.ibixiong(\.com)$/i', $host)) {						$this->redirect($url);					} else {						$this->redirect(DOMAIN);					}				} else {					$this->redirect(DOMAIN);				}							} else {				$this->forward("index");			}						//print_r($post_title);			//print_r($post_url);			//print_r($post_content);			//echo "</pre>";		}	}	public function ajaxloginAction() {		$this->session = Yaf_Session::getInstance();		if ($this->getRequest()->isPost()) {					if ($this->session->get('login') == 1) {				echo "<script>alert('您已经登录了')</script>";				//sleep(3);				exit();				//$this->redirect(Yaf_Application::app()->getConfig()->domain->name."/");							} 									$this->session->start();			$loginmodel = new LoginModel();			//echo __METHOD__ ."has been called";			$userlogin = $this->getRequest()->getPost("username");			$logintype = '';			//echo "<pre>";			if (empty($userlogin)) {				echo "用户名为空";				exit();			} else if (preg_match_all("/^[a-zA-Z0-9_]{3,16}$/i", $userlogin, $matches)) {				$logintype = 'user_login';			} else if (preg_match_all("/^[\w\d]+[\w\d-.]*@[\w\d-.]+\.[\w\d]{2,10}$/i", $userlogin, $matches)) {				$logintype = 'user_email';			} else {				echo "用户名不合法";				exit();			}			$data['user_login'] = $userlogin;			$data['user_password'] = $this->getRequest()->getPost("password");									$data['user_lastlogintime'] = date("Y-m-d H:i:s");			$data['user_lastlogintime_gmt'] = date("e");			$data['user_lastlogin_ip'] = $_SERVER['REMOTE_ADDR'];			//print_r($data);			//print_r($logintype);			$user_info = $loginmodel->get_user($logintype,$data['user_login']);			//print_r($user_info);			if (isset($user_info['user_status']) && $user_info['user_status'] == 0) {				echo "101:帐号未激活";			} else if ($user_info['user_id']) {				//echo "user_login is find";				$salt = $user_info['user_salt'];				$password = md5($data['user_password'].$salt);				//print_r($password);				if ($password == $user_info['user_password']) {					$this->session->set('login',1);					$this->session->set('userid',$user_info['user_id']);					//$this->session->set('username',$user_info['user_login']);					$this->session->set('username',$user_info['user_nickname']);					echo "1:登陆成功";				} else {					echo "101:用户名或密码错误";					exit();				}								if ($this->getRequest()->getPost("rememberme")) {					$domain = "www.ibixiong.com";					setcookie("userid", $user_info['user_id'], time()+3600*24*365,"/",$domain,0,true);  					setcookie("username", $user_info['user_login'], time()+3600*24*365,"/",$domain,0,true);  					setcookie("password", $user_info['user_password'], time()+3600*24*365,"/",$domain,0,true); 									}			} else {				echo "101:用户名或密码错误";			}						//print_r($post_title);			//print_r($post_url);			//print_r($post_content);			//echo "</pre>";		}	}	public function logoutAction() {		$this->session = Yaf_Session::getInstance();				if ($this->session->get('login') == 0) {			echo "<script>alert('您还没有登录')</script>";			//sleep(3);			$this->redirect(Yaf_Application::app()->getConfig()->domain->name."/");		} 						$this->session->del('login');		$this->session->del('userid');		$this->session->del('username');		$domain = "www.ibixiong.com";		setcookie("userid", "" , time()-3600*24*365,"/",$domain,0,true);  		setcookie("username", "" , time()-3600*24*365,"/",$domain,0,true);  		setcookie("password", "" , time()-3600*24*365,"/",$domain,0,true); 				$user_id = $this->getRequest()->getCookie('userid');		$username = $this->getRequest()->getCookie('username');		$password = $this->getRequest()->getCookie('password');		/*echo "cookie:".$_COOKIE['userid'];		echo "<br />";		echo "cookie:".$_COOKIE['username'];		echo "<br />";		echo "cookie:".$_COOKIE['password'];		echo "<br />";		echo "cookie_yaf:".$user_id;		echo "<br />";		echo "cookie_yaf:".$username;		echo "<br />";		echo "cookie_yaf:".$password;		echo "<br />";*/		$login = $this->session->get('login');		$username2 = $this->session->get('username');		$password2 = $this->session->get('password');		/*echo "session:".$login;		echo "<br />";		echo "session:".$username2;		echo "<br />";		echo "session:".$password2;*/				$this->redirect(Yaf_Application::app()->getConfig()->domain->name."/");	}		protected function getnavbar($type="login") {		$loginmodel = new LoginModel();				$allnavbars = $loginmodel->get_navbars($type);				return $allnavbars;	}		public function getrightbar() {		$rightbar_result = array();		$loginmodel = new LoginModel();		//echo "<pre>";		$rightbars = $loginmodel->get_rightbars();		//print_r($rightbars);		foreach($rightbars as $rightbar) {						$hotlinks = $rightbar['option_others'];			$rightbar['hotlinks'] = unserialize($hotlinks);			//echo "<pre>";			//print_r($rightbar['hotlinks']);			//echo "</pre>";			foreach ($rightbar['hotlinks'] as $k => $hotlink) {				//print_r($hotlink);				//echo "<br />";				$hotlink['title'] = base64_decode($hotlink['title']); 				//print_r($hotlink);				//echo "<br />";				$rightbar['hotlinks'][$k] = $hotlink;			}			$rightbar_result[] = $rightbar;		}				//$rightbar = $rightbars;		//var_dump($rightbar_result);		//echo "</pre>";		return $rightbar_result;	}			public function checkdata($data,$data_repeat) {		//print_r($data);		//print_r($data_repeat);		if (!preg_match_all("/([a-z0-9_\.]+)/i", $data['user_login'], $matches)) {			echo "用户名不合法";			exit();		}			if (!preg_match_all("/([a-z0-9_\-\.]+)@(([a-z0-9]+[_\-]?)\.)+[a-z]{2,3}/i", $data['user_email'], $matches)) {			echo "邮件不合法";			exit();		}		//print_r($matches);		//print_r($matches[0][0]);		$data['user_email'] = $matches[0][0];		if (strcmp($data['user_password'],$data_repeat['repeatpassword']) !== 0) {			echo "输入的密码不一致";			exit();		}		return $data;	}}