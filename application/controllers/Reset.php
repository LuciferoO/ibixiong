<?php/***	用户登录页面**/class ResetController  extends Yaf_Controller_Abstract {	protected $session ;	public function indexAction() {		$resetmodel = new ResetModel();		if ($this->getRequest()->isPost()) {			//echo "<pre>";			$email = $this->getRequest()->getPost("inputemail");			$user_info = $this->checkemail($email);			//print_r($user_info);			if ($user_info) {				$salt = $user_info['user_salt'];				$time = time();				$resetkey = md5($user_info['user_salt'].$time);								$data = array();				$data['reset_key'] = $resetkey;				$data['reset_key_time'] = $time;								$rowaffected = $resetmodel->update_user_info('users',$data,$user_info['user_id']);								if ($rowaffected) {					//echo "$rowaffected";					$smtp = "smtp.ym.163.com";					$smtpport=25;					$title="重置密码 - i比熊";     //邮件标题					$mailfrom="<ibixiong@ibixiong.com>"; //发送人					$username = "ibixiong@ibixiong.com";//"qiuyanjie";					$passwd="i@bixiong";   //SMTP密码					$mailsend="ibixiong@ibixiong.com"; //对方显示的发送人					$replyto="<ibixiong@ibixiong.com>";//回复邮件人					$sendto="<$email>"; //收件人					$mail='						<span style="color:#000;">欢迎使用i比熊密码找回功能</span>												<span style="color:#000;"><a href="http://www.ibixiong.com" target="_blank">i 比熊</a> 专注于精品阅读</span>						<br />						<strong><span style="color:#000;">密码重置链接如下：</span></strong>						<a href="'. DOMAIN .'/Reset/password/id/'.$user_info['user_id'].'/sign/'.$resetkey.'" target="_blank">'.DOMAIN.'/Reset/password/id/'.$user_info['user_id'].'/sign/'.$resetkey.'</a>						<br />						<strong>							<span style="color:#FF0000;">链接有效时间为半小时</span>						</strong>					';					$sendmail = new Mail_SendMail($smtp, $smtpport, $title, $username, $passwd, $mailfrom, $mailsend, $replyto, $sendto, $mail);					$result = $sendmail->Send();					if($result) {						echo "1:提交成功";					}				}			} else {				echo "101:邮箱不存在";			}			//echo "</pre>";		} else {			$navbars = $this->getnavbar("login");			$rightbars = $this->getrightbar("register");						if (Yaf_Registry::get("register")) {				$this->getView()->assign("activekey",Yaf_Registry::get("register"));			}						$this->getView()->assign("title"," 忘记密码 - i比熊 ");			$this->getView()->assign("navbar",$navbars);			$this->getView()->assign("rightbar",$rightbars);			$this->getView()->display(Yaf_Application::app()->getConfig()->smarty->template_dir . "index/reset.tpl");		}	}		public function passwordAction() {		if ($this->getRequest()->isPost()) {			$user_id = $this->getRequest()->getPost("id");			$reset_key  = $this->getRequest()->getPost("sign");			$newpassword = $this->getRequest()->getPost("newpassword");			$repeatpassword = $this->getRequest()->getPost("newrepeatpassword");						$resetmodel = new ResetModel();			$user_info = $resetmodel->get_userinfo('user_id',$user_id);			//print_r($user_info);			if ( $user_info['reset_key'] != $reset_key ) {				echo "验证失败";				exit();			}						if ($newpassword != $repeatpassword) {				echo "两次密码不一致";				exit();			} else {				$data = array();				$data['user_password'] = md5($newpassword.$user_info['user_salt']);				$rowaffected = $resetmodel->update_user_info('users',$data,$user_info['user_id']);				if ($rowaffected) {					echo 1;				}			}		} else {			$user_id = $this->getRequest()->getParam("id");			$reset_key = $this->getRequest()->getParam("sign");			$resetmodel = new ResetModel();			$user_info = $resetmodel->get_userinfo('user_id',$user_id);			$time_before = time() - $user_info['reset_key_time'];			if ($user_info['reset_key'] == $reset_key && $time_before <= 1800) {				$navbars = $this->getnavbar("login");				$rightbars = $this->getrightbar("register");								if (Yaf_Registry::get("register")) {					$this->getView()->assign("activekey",Yaf_Registry::get("register"));				}								$this->getView()->assign("title"," 重置密码 - i比熊 ");				$this->getView()->assign("navbar",$navbars);				$this->getView()->assign("rightbar",$rightbars);				$this->getView()->assign("id",$user_id);				$this->getView()->assign("sign",$reset_key);				$this->getView()->display(Yaf_Application::app()->getConfig()->smarty->template_dir . "index/resetpassword.tpl");			} else {				echo "链接已经失效";			}		}	}		public function checkAction() {		$resetmodel = new ResetModel();		$type = $this->getRequest()->getPost("type");				switch($type) {			case 'email':				$email = $this->getRequest()->getPost("inputemail");				$flag = $this->checkemail($email);				if ($flag) {					echo 1;				} else {					echo 0;				}				break;			default:break;		}			}		protected function checkemail($email) {		$resetmodel = new ResetModel();		$user_info = $resetmodel->get_userinfo('user_email',$email);		if ($user_info) {			return $user_info;		} else {			return false;		}	}		protected function getnavbar($type="login") {		$resetmodel = new ResetModel();				$allnavbars = $resetmodel->get_navbars($type);				return $allnavbars;	}		public function getrightbar() {		$rightbar_result = array();		$resetmodel = new ResetModel();		//echo "<pre>";		$rightbars = $resetmodel->get_rightbars();		//print_r($rightbars);		foreach($rightbars as $rightbar) {						$hotlinks = $rightbar['option_others'];			$rightbar['hotlinks'] = unserialize($hotlinks);			//echo "<pre>";			//print_r($rightbar['hotlinks']);			//echo "</pre>";			foreach ($rightbar['hotlinks'] as $k => $hotlink) {				//print_r($hotlink);				//echo "<br />";				$hotlink['title'] = base64_decode($hotlink['title']); 				//print_r($hotlink);				//echo "<br />";				$rightbar['hotlinks'][$k] = $hotlink;			}			$rightbar_result[] = $rightbar;		}				//$rightbar = $rightbars;		//var_dump($rightbar_result);		//echo "</pre>";		return $rightbar_result;	}			public function checkdata($data,$data_repeat) {		//print_r($data);		//print_r($data_repeat);		if (!preg_match_all("/([a-z0-9_\.]+)/i", $data['user_login'], $matches)) {			echo "用户名不合法";			exit();		}			if (!preg_match_all("/([a-z0-9_\-\.]+)@(([a-z0-9]+[_\-]?)\.)+[a-z]{2,3}/i", $data['user_email'], $matches)) {			echo "邮件不合法";			exit();		}		//print_r($matches);		//print_r($matches[0][0]);		$data['user_email'] = $matches[0][0];		if (strcmp($data['user_password'],$data_repeat['repeatpassword']) !== 0) {			echo "输入的密码不一致";			exit();		}		return $data;	}}